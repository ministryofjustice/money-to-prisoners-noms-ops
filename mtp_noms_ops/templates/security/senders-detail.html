{% extends 'base.html' %}
{% load i18n %}
{% load mtp_common %}
{% load security %}

{% block page_title %}{{ view.title }} – {{ block.super }}{% endblock %}

{% block inner_content %}
  {% language_switch %}
  <div class="mtp-sender-summary {% if sender.bank_transfer_details %}mtp-sender-summary__bank-transfer{% elif sender.debit_card_details %}mtp-sender-summary__debit-card{% endif %}">
    <header>
      <h1 class="heading-xlarge">{{ view.title }}{% if sender.debit_card_details %}*{% endif %}</h1>
    </header>

    {% if sender.bank_transfer_details %}
      <p class="lede">
        {% trans 'Bank transfer payments with these details' %}
      </p>

      <div class="grid-row mtp-sender-summary__details">
        <div class="column-one-third">
          {% random_string as profile_label %}
          <div id="mtp-label-{{ profile_label }}" class='mtp-sender-label' aria-hidden="true">{% trans 'Account number' %}</div>
          <strong role="definition" aria-labelledby="mtp-label-{{ profile_label }}">
            {{ sender.bank_transfer_details.0.sender_account_number|default:'—' }}
          </strong>
        </div>
        <div class="column-one-third">
          {% random_string as profile_label %}
          <div id="mtp-label-{{ profile_label }}" class='mtp-sender-label' aria-hidden="true">{% trans 'Sort code' %}</div>
          <strong role="definition" aria-labelledby="mtp-label-{{ profile_label }}">
            {{ sender.bank_transfer_details.0.sender_sort_code|format_sort_code }}
          </strong>
        </div>
        {% if sender.bank_transfer_details.0.sender_roll_number %}
          <div class="column-one-third">
            {% random_string as profile_label %}
            <div id="mtp-label-{{ profile_label }}" class='mtp-sender-label' aria-hidden="true">{% trans 'Roll number (for building societies)' %}</div>
            <strong role="definition" aria-labelledby="mtp-label-{{ profile_label }}">
              {{ sender.bank_transfer_details.0.sender_roll_number }}
            </strong>
          </div>
        {% endif %}
      </div>

    {% elif sender.debit_card_details %}
      <p class="lede">{% trans 'Debit card payments with these details' %}</p>

      <div class="grid-row mtp-sender-summary__details">
        <div class="column-one-third">
          {% random_string as profile_label %}
          <div id="mtp-label-{{ profile_label }}" class='mtp-sender-label' aria-hidden="true">{% trans 'Last 4 digits of card number' %}</div>
          <strong role="definition" aria-labelledby="mtp-label-{{ profile_label }}">
            {{ sender.debit_card_details.0.card_number_last_digits|format_card_number }}
          </strong>
        </div>
        <div class="column-one-quarter">
          {% random_string as profile_label %}
          <div id="mtp-label-{{ profile_label }}" class='mtp-sender-label' aria-hidden="true">{% trans 'Expiry date' %}</div>
          <strong role="definition" aria-labelledby="mtp-label-{{ profile_label }}">
            {{ sender.debit_card_details.0.card_expiry_date|default_if_none:'—' }}
          </strong>
        </div>
        <div class="column-one-quarter">
          {% random_string as profile_label %}
          <div id="mtp-label-{{ profile_label }}" class='mtp-sender-label' aria-hidden="true">{% trans 'Postcode' %}</div>
          <strong role="definition" aria-labelledby="mtp-label-{{ profile_label }}">
            {{ sender.debit_card_details.0.postcode|default_if_none:'—' }}
          </strong>
        </div>
      </div>

    {% else %}

      <p>—</p>

    {% endif %}

    <div class="grid-row mtp-sender-summary__details">
      <div class="column-two-thirds">
        <div class="column-one-third col-1">
          {% random_string as profile_label %}
          <div id="mtp-label-{{ profile_label }}" class='mtp-sender-label' aria-hidden="true">{% trans 'Credits sent' %}</div>
          <strong role="definition" aria-labelledby="mtp-label-{{ profile_label }}">{{ sender.credit_count }}</strong>
        </div>

        <div class="column-one-third">
          {% random_string as profile_label %}
          <div id="mtp-label-{{ profile_label }}" class='mtp-sender-label' aria-hidden="true">{% trans 'Prisoners' %}</div>
          <strong role="definition" aria-labelledby="mtp-label-{{ profile_label }}">{{ sender.prisoner_count }}</strong>
        </div>

        <div class="column-one-third">
          {% random_string as profile_label %}
          <div id="mtp-label-{{ profile_label }}" class='mtp-sender-label' aria-hidden="true">{% trans 'Prisons' %}</div>
          <strong role="definition" aria-labelledby="mtp-label-{{ profile_label }}">{{ sender.prison_count }}</strong>
        </div>
      </div>

      <div class="column-one-third">
        {% random_string as profile_label %}
        <div id="mtp-label-{{ profile_label }}" class='mtp-sender-label' aria-hidden="true">{% trans 'Total amount sent' %}</div>
        <strong role="definition" aria-labelledby="mtp-label-{{ profile_label }}">{{ sender.credit_total|currency }}</strong>
      </div>
    </div>

    {% include 'security/includes/save-search.html' with form=form pin_label=_('Monitor this sender on your home page') unpin_label=_('Stop monitoring this sender') only %}
  </div>

  {% include 'mtp_common/forms/error-summary.html' with form=form only %}

  {% if form.is_valid %}
    <div class="mtp-results-list">
      <h2 class="heading-large">{% trans 'Credits sent' %}</h2>

      <div class="panel panel-border-narrow">
        {% include 'security/forms/search-description.html' with form=form only %}

        <div class="print-hidden mtp-links">
          <a class="js-Print" href="#print-dialog">{% trans 'Print' %}</a> &nbsp;
          <a href="{% url 'security:sender_detail_export' sender_id=sender.id %}?{{ request.GET.urlencode }}">{% trans 'Export' %}</a>
        </div>
      </div>

      <table class="mtp-sender-credit-list">
        <caption class="visually-hidden">{{ form.search_description.description }}</caption>
        <thead>
          <tr>
            <th class="{{ form|ordering_classes:'received_at' }}">
              <a href="?{{ form|query_string_with_reversed_ordering:'received_at' }}">
                <span>
                  {% trans 'Date received' %}
                  {% describe_ordering_for_screenreader form 'received_at' %}
                </span>
              </a>
            </th>
            <th>{% trans 'Sender' %}</th>
            <th class="{{ form|ordering_classes:'prisoner_number' }}">
              <a href="?{{ form|query_string_with_reversed_ordering:'prisoner_number' }}">
                <span>
                  {% trans 'Prisoner' %}
                  {% describe_ordering_for_screenreader form 'prisoner_number' %}
                </span>
              </a>
            </th>
            <th class="{{ form|ordering_classes:'amount' }} number">
              <a href="?{{ form|query_string_with_reversed_ordering:'amount' }}">
                <span>
                  {% trans 'Amount' %}
                  {% describe_ordering_for_screenreader form 'amount' %}
                </span>
              </a>
            </th>
            <th>{% trans 'Credited status' %}</th>
          </tr>
        </thead>
        <tbody>
          {% for credit in credits %}
            <tr class="{% if forloop.last %}no-border{% endif %}">
              <td>
                <strong>{{ credit.received_at|date:'DATE_FORMAT' }}</strong>
              </td>
              <td>
                <strong>{{ credit.sender_name|default:'—' }}</strong>
                <p>—</p>
                {% if credit.source == 'online' %}
                  <div class="mtp-sender-label">{% trans 'Address' %}</div>
                  <div>{{ credit.billing_address.line1 }}</div>
                  <div>{{ credit.billing_address.line2 }}</div>
                  <div>{{ credit.billing_address.city }}</div>
                  <div>{{ credit.billing_address.postcode }}</div>
                  <div>{{ credit.billing_address.country }}</div>
                  <br/>
                  <div class="mtp-sender-label">{% trans 'IP' %}</div>
                  <div>{{ credit.ip_address }}</div>
                  <br/>
                  <div class="mtp-sender-label">{% trans 'Email' %}</div>
                  <div>{{ credit.sender_email }}</div>
                {% elif credit.source == 'bank_transfer' %}
                  <div class="mtp-sender-label">{% trans 'Account number' %}</div>
                  <div>{{ credit.sender_account_number }}</div>
                  <br/>
                  <div class="mtp-sender-label">{% trans 'Sort code' %}</div>
                  <div>{{ credit.sender_sort_code }}</div>
                  {% if credit.sender_roll_number %}
                    <br/>
                    <div class="mtp-sender-label">{% trans 'Roll number' %}</div>
                    <div>{{ credit.sender_roll_number }}</div>
                  {% endif %}
                {% endif %}
              </td>
              <td>
                {% if credit.prisoner_number %}
                  <strong><a href="{{ credit|prisoner_profile_search_url }}" class="mtp-print-url-hidden">{{ credit.prisoner_number }}</a></strong>
                {% endif %}
                <p>—</p>
                <div class="mtp-sender-label">{% trans 'Prisoner name' %}</div>
                <div>{{ credit.prisoner_name|default_if_none:'—' }}</div>
                <br/>
                <div class="mtp-sender-label">{% trans 'Prison' %}</div>
                <div>{{ credit.prison_name|default_if_none:'—' }}</div>
              </td>
              <td class="number">
                <strong>{{ credit.amount|currency }}</strong>
              </td>
              <td>
                <strong>
                  {% if credit.resolution == 'credited' %}
                    {{ credit.credited_at.date }}
                  {% elif credit.resolution == 'refunded' %}
                    {% trans 'Refunded' %}
                  {% else %}
                    {% trans 'No' %}
                  {% endif %}
                </strong>
                <p>—</p>
                <div class="mtp-sender-label">{% trans 'Crediting staff' %}</div>
                <div>{{ credit.owner_name|default:'—' }}</div>
                <br/>
                <div class="mtp-sender-label">{% trans 'NOMIS ID' %}</div>
                <div>{{ credit.nomis_transaction_id|default:'—' }}</div>
              </td>
            </tr>
          {% empty %}
            <tr class="no-border">
              <td colspan="6">{% trans 'No matching credits found' %}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

      {% page_list page=form.cleaned_data.page page_count=form.page_count query_string=form.query_string %}
    </div>
  {% endif %}

{% endblock %}
