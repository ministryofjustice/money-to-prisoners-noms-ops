{% extends 'base.html' %}
{% load i18n %}
{% load mtp_common %}
{% load security %}

{% block inner_content %}

  <header>
    {% language_switch %}
    <h1 class="heading-xlarge">{{ view.title }}</h1>
  </header>

  {% include 'mtp_common/includes/message_box.html' %}

  <form method="get">
    {% include 'mtp_common/forms/error-summary.html' with form=form only %}

    <input type="hidden" name="page" value="1">

    <div class="print-hidden">
      <h2 class="heading-medium">{% trans 'Filter by' %}</h2>

      {% include view.form_template_name with view=view form=form only %}
    </div>

      {% if form.cleaned_data %}
      <div class="mtp-results-list">
        <h2 class="heading-medium">{% trans 'Showing all payments' %}</h2>

        <p class="mtp-search-description__text">
          {{ form.search_description }}
        </p>

        <div class="print-hidden mtp-links">
          <a class="js-Print" href="#print-dialog">{% trans 'Print' %}</a> &nbsp;
          <a href="{% url 'security:credits_export' %}?{{ request.GET.urlencode }}">{% trans 'Export' %}</a>
        </div>

        <div class="print-hidden">
          {% include 'security/select-field.html' with field=form.ordering only %}
        </div>

        <table>
          <thead>
            <tr>
              <th>{% trans 'Date received' %}</th>
              <th>{% trans 'Sender and type' %}</th>
              <th class="number">{% trans 'Amount' %}</th>
              <th>{% trans 'Prisoner' %}</th>
              <th>{% trans 'Prison' %}</th>
              <th>{% trans 'Credited status' %}</th>
            </tr>
          </thead>
          <tbody>
            {% for credit in credits|parse_date_fields %}
              <tr {% if forloop.last %}class="no-border"{% endif %}>
                <td>
                  <p>{{ credit.received_at|date:'DATE_FORMAT' }}</p>
                </td>
                <td>
                  {% if credit.source == 'online' %}
                    <p class="mtp-credit__card">
                      <strong><a href="{% url 'security:sender_list' %}?page=1&amp;sender_name={{ credit.sender_name }}">{{ credit.sender_name | default_if_none:'—' }}</a></strong><br />
                      {% trans 'Debit card' %}
                    </p>
                  {% else %}
                    <p class="mtp-credit__transfer">
                    <strong><a href="{% url 'security:sender_list' %}?page=1&amp;sender_name={{ credit.sender_name }}">{{ credit.sender_name | default_if_none:'—' }}</a></strong><br />
                    {% trans 'Bank transfer' %}
                    </p>
                  {% endif %}
                </td>
                <td class="number">
                  <p><strong>£{{ credit.amount|currency }}</strong></p>
                </td>
                <td>
                  {% if credit.prisoner_number %}
                    <p><strong><a href="{% url 'security:credit_list' %}?page=1&amp;prisoner_number={{ credit.prisoner_number }}">{{ credit.prisoner_number }}</a></strong><br />
                    {{ credit.prisoner_name|default_if_none:'—' }}</p>
                  {% endif %}
                </td>
                <td>
                  <p>{{ credit.prison_name|default_if_none:'—' }}</p>
                </td>
                <td>
                  {% if credit.resolution == 'credited' %}
                    <p>{{ credit.credited_at.date }} <br />
                    {% trans 'by' %} {{ credit.owner_name|default_if_none:'—' }}</p>
                  {% else %}
                    <p>{% trans 'No' %}</p>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr class="no-border">
                <td colspan="7">{% trans 'No matching credits found' %}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        {% page_list page=form.cleaned_data.page page_count=form.page_count query_string=form.query_string %}
      </div>
      {% endif %}

  </form>

{% endblock %}
